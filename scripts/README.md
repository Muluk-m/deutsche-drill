# 批量获取音标脚本

## 功能说明

这个脚本用于批量从 Wiktionary 获取所有德语单词的 IPA 音标，并将音标数据保存到 `public/words.json` 中。

## 使用方法

### 1. 首次使用需要安装依赖

```bash
npm install
# 或
pnpm install
```

这会自动安装 `jsdom` 等必要的依赖。

### 2. 运行脚本

```bash
npm run fetch-phonetics
```

或者

```bash
node scripts/fetchPhonetics.js
```

## 工作原理

1. 读取 `public/words.json` 文件
2. 对于每个没有音标的单词：
   - 清理单词（去掉冠词、复数标记等）
   - 使用 `curl` 命令调用 Wiktionary API 获取 HTML 页面
   - 提取 `<span class="ipa">` 标签中的音标
   - 确保音标格式为 `/xxx/`
   - 更新到 word 对象的 `phonetic` 字段
3. 每处理 10 个单词自动保存一次（防止中断丢失数据）
4. 处理完成后显示统计信息

**注意**：脚本使用系统的 `curl` 命令，需要确保系统已安装 curl。

## 特性

- ✅ **智能识别**：自动区分单词和句子，句子不获取音标
- ✅ **断点续传**：已有音标的单词会自动跳过
- ✅ **失败记录**：获取失败的单词会被标记，下次运行自动跳过
- ✅ **自动保存**：每 10 个单词保存一次进度
- ✅ **速率限制**：默认每个请求间隔 300ms，避免 API 限流
- ✅ **重试机制**：失败的请求自动重试 1 次（总共尝试 2 次）
- ✅ **完整 Headers**：使用 curl 模拟真实浏览器请求，提高成功率
- ✅ **详细日志**：实时显示处理进度和结果
- ✅ **错误处理**：单个单词失败不影响整体进度

## 输出示例

```
🚀 开始批量获取音标...

📚 共 2060 个单词

[1/2060] 🔍 获取: Deutschland
[1/2060] ✅ 成功: Deutschland -> /ˈdɔʏtʃlant/

[2/2060] 🔍 获取: Österreich
[2/2060] ✅ 成功: Österreich -> /ˈøːstɐʁaɪ̯ç/

[3/2060] ⏭️  跳过（句子/短语）: Ich bin ein Student.

[4/2060] ⏭️  跳过（已有音标）: das Haus

...

💾 已保存进度 (10/2060)

...

==================================================
✨ 批量获取完成！
✅ 成功: 1850
⏭️  跳过: 150
⚠️  失败: 60
📊 总计: 2060
==================================================
```

## 注意事项

1. **curl 依赖**：需要系统已安装 curl 命令（macOS/Linux 默认已安装）
2. **网络连接**：需要能访问 `de.wiktionary.org`
3. **执行时间**：2000+ 个单词大约需要 10-15 分钟
4. **中断恢复**：如果脚本中断，再次运行会从未完成的单词继续
5. **失败单词**：部分单词可能在 Wiktionary 上没有音标数据

## 修改参数

可以在脚本中修改以下参数：

```javascript
const DELAY_MS = 300; // API 调用间隔（毫秒）
const maxRetries = 1;  // 最大重试次数（即总共尝试 2 次）
```

如果遇到 API 限流或网络不稳定，可以：
- 增加 `DELAY_MS` 值（如改为 500）
- 增加 `maxRetries` 值（如改为 2，即总共尝试 3 次）

## 重新获取失败的单词

如果想重新尝试获取之前失败的单词，需要手动移除 `phoneticFailed` 标记：

```bash
# 可以编辑 words.json，删除所有 "phoneticFailed": true 字段
# 或者使用脚本批量处理
```

## 数据格式

更新后的 `words.json` 格式：

```json
[
  {
    "word": "das Haus, -̈er",
    "zh_cn": "房子",
    "phonetic": "/haʊ̯s/"
  }
]
```

